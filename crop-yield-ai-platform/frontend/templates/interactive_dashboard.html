{% extends "base.html" %}

{% block title %}Dashboard - CropAI Platform{% endblock %}

{% block extra_head %}
<!-- Three.js for 3D graphics -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<!-- GSAP for animations -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
<!-- Chart.js for data visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        font-family: 'Inter', sans-serif;
    }
    
    .dashboard-hero {
        height: 60vh;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        margin-top: 80px;
    }
    
    .hero-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
    }
    
    .welcome-content {
        position: relative;
        z-index: 2;
        text-align: center;
        color: white;
    }
    
    .welcome-title {
        font-size: 3rem;
        font-weight: 800;
        background: linear-gradient(45deg, #ffffff, #10b981, #34d399);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 1rem;
    }
    
    .stats-3d-container {
        position: relative;
        margin: 4rem 0;
        height: 400px;
    }
    
    .stats-3d-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    
    .interactive-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin: 4rem 0;
        position: relative;
        z-index: 10;
    }
    
    .interactive-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 2rem;
        color: white;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .interactive-card:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: 0 20px 40px rgba(16, 185, 129, 0.2);
        border-color: rgba(16, 185, 129, 0.3);
    }
    
    .interactive-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(45deg, #10b981, #34d399, #6ee7b7);
    }
    
    .card-icon-3d {
        width: 80px;
        height: 80px;
        background: linear-gradient(45deg, #10b981, #34d399);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        transition: all 0.3s ease;
    }
    
    .interactive-card:hover .card-icon-3d {
        transform: rotateY(180deg) scale(1.1);
        box-shadow: 0 15px 30px rgba(16, 185, 129, 0.4);
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 2rem 0;
    }
    
    .floating-particles {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
    }
    
    .data-visualization {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 25px;
        padding: 2rem;
        margin: 3rem 0;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }
    
    .morphing-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        opacity: 0.3;
    }
    
    .field-3d-preview {
        height: 200px;
        position: relative;
        border-radius: 15px;
        overflow: hidden;
        margin: 1rem 0;
    }
    
    .field-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<!-- Morphing Background -->
<canvas class="morphing-bg" id="morphingBg"></canvas>

<!-- Dashboard Hero Section -->
<div class="dashboard-hero">
    <canvas class="hero-canvas" id="dashboardCanvas"></canvas>
    <div class="welcome-content">
        <h1 class="welcome-title">Welcome Back, {{ current_user.name or current_user.username }}!</h1>
        <p class="lead text-light">Your AI-Powered Agricultural Command Center</p>
    </div>
</div>

<div class="container mt-5">
    <!-- 3D Stats Visualization -->
    <div class="stats-3d-container">
        <canvas class="stats-3d-canvas" id="stats3DCanvas"></canvas>
    </div>
    
    <!-- Interactive Cards Grid -->
    <div class="interactive-cards">
        <div class="interactive-card pulse-animation">
            <div class="card-icon-3d">üåæ</div>
            <h3>{{ fields|length }} Active Fields</h3>
            <p class="text-light">Manage your agricultural portfolio with real-time monitoring and AI insights.</p>
            <div class="field-3d-preview">
                <canvas class="field-canvas" id="fieldCanvas1"></canvas>
            </div>
            <a href="{{ url_for('add_field') }}" class="btn btn-success mt-3">
                <i class="fas fa-plus"></i> Add New Field
            </a>
        </div>
        
        <div class="interactive-card">
            <div class="card-icon-3d">ü§ñ</div>
            <h3>{{ predictions|length }} AI Predictions</h3>
            <p class="text-light">Advanced machine learning models working around the clock for your farm.</p>
            <div class="chart-container">
                <canvas id="predictionChart"></canvas>
            </div>
            <a href="{{ url_for('predict_yield_route') }}" class="btn btn-primary mt-3">
                <i class="fas fa-brain"></i> New Prediction
            </a>
        </div>
        
        <div class="interactive-card">
            <div class="card-icon-3d">üí∞</div>
            <h3>Profit Analytics</h3>
            <p class="text-light">Track your financial performance with interactive 3D visualizations.</p>
            <div class="chart-container">
                <canvas id="profitChart"></canvas>
            </div>
            <a href="{{ url_for('cost_benefit_calculator') }}" class="btn btn-warning mt-3">
                <i class="fas fa-calculator"></i> Calculate ROI
            </a>
        </div>
        
        <div class="interactive-card">
            <div class="card-icon-3d">üå¶Ô∏è</div>
            <h3>Weather Intelligence</h3>
            <p class="text-light">Real-time atmospheric conditions with AI-powered forecasting.</p>
            <div class="field-3d-preview">
                <canvas class="field-canvas" id="weatherCanvas"></canvas>
            </div>
            <div id="live-weather" class="mt-3">
                <div class="d-flex justify-content-between">
                    <span>Temperature:</span>
                    <span id="temp-display">Loading...</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Humidity:</span>
                    <span id="humidity-display">Loading...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data Visualization Section -->
    <div class="data-visualization">
        <h2 class="text-center mb-4 text-white">Interactive Field Performance</h2>
        <div class="row">
            <div class="col-md-6">
                <canvas id="yieldComparisonChart"></canvas>
            </div>
            <div class="col-md-6">
                <canvas id="marketTrendChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Floating Particles -->
<canvas class="floating-particles" id="particlesCanvas"></canvas>
{% endblock %}

{% block extra_scripts %}
<script>
// Initialize all 3D scenes and animations
document.addEventListener('DOMContentLoaded', function() {
    initDashboard3D();
    initStats3D();
    initFieldPreviews();
    initCharts();
    initMorphingBackground();
    initParticleSystem();
    loadLiveWeather();
    
    // Add interactive animations
    gsap.from('.interactive-card', {
        opacity: 0,
        y: 50,
        duration: 1,
        stagger: 0.2,
        ease: 'power3.out',
        delay: 0.5
    });
});

function initDashboard3D() {
    const canvas = document.getElementById('dashboardCanvas');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
    
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    renderer.setClearColor(0x000000, 0);
    
    // Create floating geometric shapes
    const geometries = [
        new THREE.TetrahedronGeometry(1),
        new THREE.OctahedronGeometry(1),
        new THREE.IcosahedronGeometry(1)
    ];
    
    const material = new THREE.MeshBasicMaterial({
        color: 0x10b981,
        wireframe: true,
        transparent: true,
        opacity: 0.6
    });
    
    const shapes = [];
    for(let i = 0; i < 5; i++) {
        const geometry = geometries[Math.floor(Math.random() * geometries.length)];
        const shape = new THREE.Mesh(geometry, material);
        shape.position.set(
            (Math.random() - 0.5) * 10,
            (Math.random() - 0.5) * 5,
            (Math.random() - 0.5) * 5
        );
        shapes.push(shape);
        scene.add(shape);
    }
    
    camera.position.z = 8;
    
    function animate() {
        requestAnimationFrame(animate);
        
        shapes.forEach((shape, index) => {
            shape.rotation.x += 0.01 * (index + 1);
            shape.rotation.y += 0.01 * (index + 1);
            shape.position.y += Math.sin(Date.now() * 0.001 + index) * 0.01;
        });
        
        renderer.render(scene, camera);
    }
    
    animate();
}

function initStats3D() {
    const canvas = document.getElementById('stats3DCanvas');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
    
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    renderer.setClearColor(0x000000, 0);
    
    // Create 3D bar chart
    const stats = [
        { label: 'Fields', value: {{ fields|length }}, color: 0x10b981 },
        { label: 'Predictions', value: {{ predictions|length }}, color: 0x3b82f6 },
        { label: 'Accuracy', value: 95, color: 0xf59e0b },
        { label: 'Growth', value: 15, color: 0xef4444 }
    ];
    
    stats.forEach((stat, index) => {
        const geometry = new THREE.BoxGeometry(1, stat.value / 10, 1);
        const material = new THREE.MeshBasicMaterial({ color: stat.color, transparent: true, opacity: 0.8 });
        const bar = new THREE.Mesh(geometry, material);
        
        bar.position.x = (index - stats.length / 2) * 2;
        bar.position.y = stat.value / 20;
        
        scene.add(bar);
        
        // Add floating labels
        const labelGeometry = new THREE.PlaneGeometry(1, 0.5);
        const labelMaterial = new THREE.MeshBasicMaterial({ 
            color: 0xffffff, 
            transparent: true, 
            opacity: 0.7 
        });
        const label = new THREE.Mesh(labelGeometry, labelMaterial);
        label.position.set(bar.position.x, stat.value / 10 + 1, 0);
        scene.add(label);
    });
    
    camera.position.z = 8;
    camera.position.y = 2;
    
    function animate() {
        requestAnimationFrame(animate);
        camera.position.x = Math.sin(Date.now() * 0.001) * 2;
        renderer.render(scene, camera);
    }
    
    animate();
}

function initFieldPreviews() {
    // Initialize mini 3D field visualizations
    const fieldCanvases = document.querySelectorAll('.field-canvas');
    
    fieldCanvases.forEach((canvas, index) => {
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(50, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
        
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        renderer.setClearColor(0x000000, 0);
        
        // Create field terrain
        const geometry = new THREE.PlaneGeometry(4, 4, 10, 10);
        const material = new THREE.MeshBasicMaterial({ 
            color: 0x16a085, 
            wireframe: true, 
            transparent: true, 
            opacity: 0.7 
        });
        
        const field = new THREE.Mesh(geometry, material);
        field.rotation.x = -Math.PI / 3;
        scene.add(field);
        
        // Add crops
        for(let i = 0; i < 20; i++) {
            const cropGeometry = new THREE.ConeGeometry(0.1, 0.3, 4);
            const cropMaterial = new THREE.MeshBasicMaterial({ color: 0x27ae60 });
            const crop = new THREE.Mesh(cropGeometry, cropMaterial);
            
            crop.position.set(
                (Math.random() - 0.5) * 3,
                0.15,
                (Math.random() - 0.5) * 3
            );
            scene.add(crop);
        }
        
        camera.position.set(0, 3, 3);
        camera.lookAt(0, 0, 0);
        
        function animate() {
            requestAnimationFrame(animate);
            field.rotation.z += 0.005;
            renderer.render(scene, camera);
        }
        
        animate();
    });
}

function initCharts() {
    // Prediction Chart
    const predictionCtx = document.getElementById('predictionChart').getContext('2d');
    new Chart(predictionCtx, {
        type: 'doughnut',
        data: {
            labels: ['Accurate', 'Moderate', 'Low'],
            datasets: [{
                data: [85, 10, 5],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)'
                ],
                borderColor: [
                    'rgba(16, 185, 129, 1)',
                    'rgba(245, 158, 11, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                }
            }
        }
    });
    
    // Profit Chart
    const profitCtx = document.getElementById('profitChart').getContext('2d');
    new Chart(profitCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Profit Trend',
                data: [12000, 15000, 18000, 16000, 22000, 25000],
                borderColor: 'rgba(16, 185, 129, 1)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            },
            plugins: {
                legend: {
                    labels: { color: 'white' }
                }
            }
        }
    });
    
    // Yield Comparison Chart
    const yieldCtx = document.getElementById('yieldComparisonChart').getContext('2d');
    new Chart(yieldCtx, {
        type: 'radar',
        data: {
            labels: ['Rice', 'Wheat', 'Maize', 'Cotton', 'Sugarcane'],
            datasets: [{
                label: 'Current Year',
                data: [85, 75, 90, 80, 70],
                borderColor: 'rgba(16, 185, 129, 1)',
                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                borderWidth: 2
            }, {
                label: 'Previous Year',
                data: [75, 70, 80, 75, 65],
                borderColor: 'rgba(59, 130, 246, 1)',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                    pointLabels: { color: 'white' }
                }
            },
            plugins: {
                legend: {
                    labels: { color: 'white' }
                }
            }
        }
    });
    
    // Market Trend Chart
    const marketCtx = document.getElementById('marketTrendChart').getContext('2d');
    new Chart(marketCtx, {
        type: 'bar',
        data: {
            labels: ['Rice', 'Wheat', 'Cotton', 'Maize', 'Sugarcane'],
            datasets: [{
                label: 'Price (‚Çπ/quintal)',
                data: [2500, 2200, 6800, 1800, 350],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(139, 69, 19, 0.8)',
                    'rgba(168, 85, 247, 0.8)'
                ],
                borderColor: [
                    'rgba(16, 185, 129, 1)',
                    'rgba(59, 130, 246, 1)',
                    'rgba(245, 158, 11, 1)',
                    'rgba(139, 69, 19, 1)',
                    'rgba(168, 85, 247, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            },
            plugins: {
                legend: {
                    labels: { color: 'white' }
                }
            }
        }
    });
}

function initMorphingBackground() {
    const canvas = document.getElementById('morphingBg');
    const ctx = canvas.getContext('2d');
    
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const shapes = [];
    for(let i = 0; i < 5; i++) {
        shapes.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: Math.random() * 100 + 50,
            dx: (Math.random() - 0.5) * 2,
            dy: (Math.random() - 0.5) * 2,
            hue: Math.random() * 60 + 120
        });
    }
    
    function animateBackground() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        shapes.forEach(shape => {
            shape.x += shape.dx;
            shape.y += shape.dy;
            
            if(shape.x < 0 || shape.x > canvas.width) shape.dx *= -1;
            if(shape.y < 0 || shape.y > canvas.height) shape.dy *= -1;
            
            const gradient = ctx.createRadialGradient(
                shape.x, shape.y, 0,
                shape.x, shape.y, shape.size
            );
            gradient.addColorStop(0, `hsla(${shape.hue}, 70%, 50%, 0.1)`);
            gradient.addColorStop(1, `hsla(${shape.hue}, 70%, 50%, 0)`);
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(shape.x, shape.y, shape.size, 0, Math.PI * 2);
            ctx.fill();
        });
        
        requestAnimationFrame(animateBackground);
    }
    
    animateBackground();
}

function initParticleSystem() {
    const canvas = document.getElementById('particlesCanvas');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
    
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x000000, 0);
    
    const particlesGeometry = new THREE.BufferGeometry();
    const particlesCount = 2000;
    const posArray = new Float32Array(particlesCount * 3);
    
    for(let i = 0; i < particlesCount * 3; i++) {
        posArray[i] = (Math.random() - 0.5) * 50;
    }
    
    particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
    
    const particlesMaterial = new THREE.PointsMaterial({
        size: 0.03,
        color: 0x10b981,
        transparent: true,
        opacity: 0.6
    });
    
    const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
    scene.add(particlesMesh);
    
    camera.position.z = 20;
    
    function animateParticles() {
        requestAnimationFrame(animateParticles);
        
        particlesMesh.rotation.y += 0.002;
        particlesMesh.rotation.x += 0.001;
        
        renderer.render(scene, camera);
    }
    
    animateParticles();
}

function loadLiveWeather() {
    fetch('/api/weather')
        .then(response => response.json())
        .then(data => {
            document.getElementById('temp-display').textContent = `${data.temperature}¬∞C`;
            document.getElementById('humidity-display').textContent = `${data.humidity}%`;
        })
        .catch(error => {
            document.getElementById('temp-display').textContent = 'N/A';
            document.getElementById('humidity-display').textContent = 'N/A';
        });
}

// Handle window resize
window.addEventListener('resize', () => {
    const canvas = document.getElementById('morphingBg');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});
</script>
{% endblock %}